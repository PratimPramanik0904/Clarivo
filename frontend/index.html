<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#1E40AF" />
  <title>StrokeSpeak AI | Speech Clarity Assessment</title>

  <!-- Inter Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              900: '#1E3A8A',
              800: '#1E40AF',
              700: '#2563EB',
              600: '#3B82F6',
            },
            neutral: {
              50: '#FAFAFA',
              100: '#F5F5F5',
              200: '#E5E7EB',
              800: '#1F2937',
              900: '#111827',
            },
            success: '#10B981',
            warning: '#F59E0B',
            error: '#EF4444',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      background-color: #F9FAFB;
      color: #111827;
      overflow-x: hidden;
    }

    .panel-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
      border: 1px solid #E5E7EB;
      padding: 1.5rem;
      height: 100%;
    }

    .mic-btn {
      width: 130px;
      height: 130px;
      background: #1E40AF;
      box-shadow: 0 8px 24px rgba(30, 64, 175, 0.25);
      transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .mic-btn:hover {
      transform: scale(1.05);
    }

    .mic-btn:active {
      transform: scale(0.98);
    }

    .mic-btn.recording {
      background: #EF4444;
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.03); }
    }

    .waveform-container {
      height: 70px;
      width: 100%;
      max-width: 600px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 2px;
      padding: 12px 0;
    }

    .wave-bar {
      width: 4px;
      background: linear-gradient(to top, #1E40AF, #3B82F6);
      border-radius: 2px;
      opacity: 0.8;
      transition: height 0.1s ease;
    }

    .sentence-display {
      font-size: 1.5rem;
      line-height: 1.6;
      font-weight: 600;
      text-align: center;
      color: #1F2937;
      padding: 2rem;
      background: #F9FAFB;
      border-radius: 14px;
      border: 2px solid #E5E7EB;
      margin-bottom: 2rem;
      min-height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .score-display {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    .score-ring {
      position: relative;
      width: 140px;
      height: 140px;
    }

    .score-ring-bg,
    .score-ring-fill {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
    }

    .score-ring-bg {
      background: #F3F4F6;
    }

    .score-ring-fill {
      background: conic-gradient(#10B981 0%, #10B981 var(--score), transparent var(--score));
      transition: background 0.6s ease;
    }

    .score-ring-fill.warning {
      background: conic-gradient(#F59E0B 0%, #F59E0B var(--score), transparent var(--score));
    }

    .score-ring-fill.error {
      background: conic-gradient(#EF4444 0%, #EF4444 var(--score), transparent var(--score));
    }

    .score-text {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      font-weight: 800;
      color: #111827;
    }

    .progress-label {
      font-size: 0.875rem;
      color: #6B7280;
      font-weight: 500;
    }

    .spinner {
      border: 4px solid #E5E7EB;
      border-top-color: #1E40AF;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (min-width: 1024px) {
      main {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 2rem;
        max-width: 1400px;
        margin: 2rem auto;
        padding: 0 1.5rem;
      }

      #leftPanel, #rightPanel {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      #centralPanel {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
      }
    }

    @media (max-width: 1023px) {
      main {
        padding: 1rem;
      }

      #leftPanel, #rightPanel {
        display: none;
      }

      #centralPanel {
        max-width: 600px;
        margin: 0 auto;
      }
    }

    .exercise-list {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .exercise-list::-webkit-scrollbar {
      display: none;
    }

    .sentence-card {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .sentence-card:hover {
      background: #EFF6FF;
      border-color: #3B82F6;
    }

    .sentence-card.active {
      background: #DBEAFE;
      border-color: #1E40AF;
    }
  </style>
</head>
<body class="font-sans">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200 py-3 px-6">
    <div class="max-w-7xl mx-auto flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-lg bg-primary-800 flex items-center justify-center">
          <span class="text-white font-bold text-lg">üó£Ô∏è</span>
        </div>
        <div>
          <h1 class="text-lg font-semibold text-gray-900">StrokeSpeak AI</h1>
          <p class="text-xs text-gray-500">Speech Clarity Assessment</p>
        </div>
      </div>
      <div class="flex items-center space-x-4">
        <span class="bg-amber-50 text-amber-800 text-xs font-medium px-2.5 py-1 rounded-full">
          üî• Streak: <span id="streakCount">0</span>
        </span>
        <span class="bg-blue-50 text-primary-800 text-xs font-medium px-2.5 py-1 rounded-full">
          Avg: <span id="avgScore">--</span>%
        </span>
      </div>
    </div>
  </header>

  <main>
    <!-- Left Panel: Progress & Stats -->
    <div id="leftPanel">
      <div class="panel-card">
        <h2 class="font-semibold text-gray-900 mb-4">Recent Performance</h2>
        <!-- FIXED HEIGHT CHART CONTAINER -->
        <div class="h-48">
          <canvas id="progressChart"></canvas>
        </div>
        <div class="mt-4 grid grid-cols-2 gap-3">
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs text-gray-600 mb-1">Total Attempts</div>
            <div class="text-xl font-bold text-gray-900" id="totalAttempts">0</div>
          </div>
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs text-gray-600 mb-1">Best Score</div>
            <div class="text-xl font-bold text-success" id="bestScore">0%</div>
          </div>
        </div>
      </div>

      <div class="panel-card">
        <h3 class="font-medium text-gray-900 mb-3">Score Breakdown</h3>
        <div class="space-y-3">
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">Word Accuracy</span>
              <span class="font-medium" id="wordAccuracyLabel">--</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-primary-700 h-2 rounded-full transition-all duration-500" id="wordAccuracyBar" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">Pronunciation</span>
              <span class="font-medium" id="pronunciationLabel">--</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-success h-2 rounded-full transition-all duration-500" id="pronunciationBar" style="width: 0%"></div>
            </div>
          </div>
          <div>
            <div class="flex justify-between text-sm mb-1">
              <span class="text-gray-600">Prosody</span>
              <span class="font-medium" id="prosodyLabel">--</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" id="prosodyBar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Central Panel: Recording & Feedback -->
    <div id="centralPanel">
      <div class="sentence-display" id="currentSentence">
        The quick brown fox jumps over the lazy dog
      </div>

      <div id="loadingSpinner" class="hidden">
        <div class="spinner"></div>
        <p class="text-center text-primary-800 font-medium">Analyzing your speech...</p>
      </div>

      <div id="recordingUI" class="hidden mb-6">
        <div id="waveform" class="waveform-container"></div>
        <div class="text-center text-sm text-primary-800 font-medium mt-2">Recording...</div>
      </div>

      <button id="micButton" class="mic-btn rounded-full flex items-center justify-center shadow-lg mb-6">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
      </button>

      <div id="outputBox" class="text-center text-gray-600 mb-2 text-lg font-medium">Tap mic to read the sentence aloud</div>
      
      <div id="scoreDisplay" class="score-display hidden">
        <div class="score-ring">
          <div class="score-ring-bg"></div>
          <div class="score-ring-fill" id="scoreRingFill" style="--score: 0deg;"></div>
          <div class="score-text" id="scoreValue">--</div>
        </div>
        <div class="progress-label">Clarity Score</div>
      </div>

      <div id="transcriptionBox" class="hidden mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 max-w-md">
        <div class="text-xs text-gray-600 mb-1">You said:</div>
        <div class="text-base font-medium text-gray-900" id="transcriptionText">--</div>
      </div>

      <div id="actionButtons" class="hidden mt-6 flex gap-3">
        <button id="tryAgainBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-900 font-medium py-2.5 px-6 rounded-lg text-sm transition">
          Try Again
        </button>
        <button id="nextSentenceBtn" class="bg-primary-700 hover:bg-primary-800 text-white font-medium py-2.5 px-6 rounded-lg text-sm transition">
          Next Sentence ‚Üí
        </button>
      </div>
    </div>

    <!-- Right Panel: Sentence Library -->
    <div id="rightPanel">
      <div class="panel-card">
        <h2 class="font-semibold text-gray-900 mb-3">Practice Sentences</h2>
        <div class="exercise-list space-y-2 max-h-80 overflow-y-auto pr-1" id="sentenceList">
          <!-- Loaded dynamically -->
        </div>
      </div>

      <div class="panel-card">
        <h3 class="font-medium text-gray-900 mb-3">Session Info</h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Server Status:</span>
            <span class="font-medium" id="serverStatus">
              <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mr-1"></span>
              Checking...
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Model:</span>
            <span class="font-medium text-gray-900">Whisper Base</span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Session Time:</span>
            <span class="font-medium text-gray-900" id="sessionTime">0:00</span>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = 'http://localhost:8000';
    
    // State
    let currentSentenceIndex = 0;
    let sentences = [
      "The quick brown fox jumps over the lazy dog",
      "I enjoy walking in the park every morning",
      "The weather is beautiful today",
      "My favorite color is deep blue",
      "She reads books before going to sleep"
    ];
    let isRecording = false;
    let mediaRecorder = null;
    let audioChunks = [];
    let sessionData = {
      attempts: 0,
      scores: [],
      streak: 0,
      bestScore: 0,
      totalScore: 0
    };
    let sessionStartTime = Date.now();

    // DOM Elements
    const micBtn = document.getElementById('micButton');
    const recordingUI = document.getElementById('recordingUI');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const outputBox = document.getElementById('outputBox');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const scoreValue = document.getElementById('scoreValue');
    const scoreRingFill = document.getElementById('scoreRingFill');
    const transcriptionBox = document.getElementById('transcriptionBox');
    const transcriptionText = document.getElementById('transcriptionText');
    const actionButtons = document.getElementById('actionButtons');
    const currentSentenceEl = document.getElementById('currentSentence');
    const sentenceListEl = document.getElementById('sentenceList');

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      initializeChart();
      renderSentences();
      checkServerStatus();
      updateSessionTime();
      setInterval(updateSessionTime, 1000);
    });

    // === STATIC CHART (HARDCODED) ===
    function initializeChart() {
      const ctx = document.getElementById('progressChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Attempt 1', 'Attempt 2', 'Attempt 3', 'Attempt 4', 'Attempt 5'],
          datasets: [{
            label: 'Clarity Score (%)',
            data: [65, 72, 78, 83, 87],
            borderColor: '#1E40AF',
            backgroundColor: 'rgba(30, 64, 175, 0.08)',
            borderWidth: 2.5,
            pointBackgroundColor: '#1E40AF',
            pointRadius: 4,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { min: 0, max: 100, ticks: { font: { size: 10 } } },
            x: { ticks: { font: { size: 10 } } }
          }
        }
      });
    }

    // Render sentences list
    function renderSentences() {
      sentenceListEl.innerHTML = sentences.map((s, i) => `
        <div class="sentence-card p-3 bg-gray-50 rounded-lg border border-gray-200 ${i === 0 ? 'active' : ''}" 
             onclick="selectSentence(${i})">
          <p class="text-sm font-medium text-gray-800">${s}</p>
        </div>
      `).join('');
      updateSentence();
    }

    function updateSentence() {
      currentSentenceEl.textContent = sentences[currentSentenceIndex];
      const cards = sentenceListEl.querySelectorAll('.sentence-card');
      cards.forEach((card, i) => card.classList.toggle('active', i === currentSentenceIndex));
    }

    window.selectSentence = (index) => {
      currentSentenceIndex = index;
      updateSentence();
      resetUI();
    };

    // Server status
    async function checkServerStatus() {
      try {
        await fetch(`${API_BASE}/`);
        document.getElementById('serverStatus').innerHTML = `
          <span class="inline-block w-2 h-2 bg-success rounded-full mr-1"></span>
          Connected
        `;
      } catch {
        document.getElementById('serverStatus').innerHTML = `
          <span class="inline-block w-2 h-2 bg-error rounded-full mr-1"></span>
          Offline
        `;
      }
    }

    function updateSessionTime() {
      const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('sessionTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    // === AUDIO RECORDING & CONVERSION ===
    micBtn.addEventListener('click', () => {
      if (isRecording) stopRecording();
      else startRecording();
    });

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          await analyzeAudio(blob);
          stream.getTracks().forEach(t => t.stop());
        };

        mediaRecorder.start();
        isRecording = true;
        micBtn.classList.add('recording');
        recordingUI.classList.remove('hidden');
        outputBox.textContent = "üé§ Recording... Click to stop";
        animateWaveform();
        setTimeout(() => { if (isRecording) stopRecording(); }, 10000);

      } catch (err) {
        alert('Microphone access denied.');
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        micBtn.classList.remove('recording');
        recordingUI.classList.add('hidden');
      }
    }

    function animateWaveform() {
      if (!isRecording) return;
      document.querySelectorAll('.wave-bar').forEach(bar => {
        bar.style.height = `${Math.random() * 50 + 10}px`;
      });
      setTimeout(animateWaveform, 100);
    }

    // === WEBM TO WAV ===
    async function webmToWavBase64(webmBlob) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const buffer = await ctx.decodeAudioData(await webmBlob.arrayBuffer());
      const offlineCtx = new OfflineAudioContext(1, buffer.duration * 16000, 16000);
      const source = offlineCtx.createBufferSource();
      source.buffer = buffer;
      source.connect(offlineCtx.destination);
      source.start();
      const rendered = await offlineCtx.startRendering();
      const wavBlob = bufferToWave(rendered, rendered.length);
      return await blobToBase64(wavBlob);
    }

    function bufferToWave(buffer, len) {
      const view = new DataView(new ArrayBuffer(44 + len * 2));
      const writeString = (offset, str) => { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); };
      writeString(0, 'RIFF'); view.setUint32(4, 36 + len * 2, true); writeString(8, 'WAVE');
      writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true);
      view.setUint32(24, 16000, true); view.setUint32(28, 16000 * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true);
      writeString(36, 'data'); view.setUint32(40, len * 2, true);
      let offset = 44;
      for (let i = 0; i < len; i++) {
        const sample = Math.max(-1, Math.min(1, buffer.getChannelData(0)[i]));
        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
        offset += 2;
      }
      return new Blob([view], { type: 'audio/wav' });
    }

    function blobToBase64(blob) {
      return new Promise(resolve => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result.split(',')[1]);
        reader.readAsDataURL(blob);
      });
    }

    // === API CALL ===
    async function analyzeAudio(audioBlob) {
      loadingSpinner.classList.remove('hidden');
      try {
        const base64Audio = await webmToWavBase64(audioBlob);
        const res = await fetch(`${API_BASE}/api/practice`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            audio_base64: base64Audio,
            target_phrase: sentences[currentSentenceIndex],
            use_whisper: true,
            generate_audio: false,
            streak: sessionData.streak
          })
        });

        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        displayResults(data);
      } catch (err) {
        outputBox.textContent = "‚ùå Server error. Is backend running?";
        outputBox.className = "text-center text-error mb-2 text-sm";
      } finally {
        loadingSpinner.classList.add('hidden');
      }
    }

    // === UI UPDATE ===
    function displayResults(data) {
      const score = data.scoring.final_score;
      const scores = data.scoring.scores;
      const color = data.scoring.color;

      scoreValue.textContent = `${score}%`;
      scoreRingFill.style.setProperty('--score', `${(score / 100) * 360}deg`);
      scoreRingFill.className = 'score-ring-fill' + (color === 'yellow' ? ' warning' : color === 'red' ? ' error' : '');

      if (score >= 80) {
        outputBox.textContent = "üéâ Excellent clarity!";
        outputBox.className = "text-center text-success mb-2 text-lg font-medium";
        sessionData.streak++;
      } else if (score >= 50) {
        outputBox.textContent = "üëç Good effort‚Äîkeep practicing";
        outputBox.className = "text-center text-warning mb-2 text-lg font-medium";
        sessionData.streak = 0;
      } else {
        outputBox.textContent = "üí™ Try speaking more clearly";
        outputBox.className = "text-center text-error mb-2 text-lg font-medium";
        sessionData.streak = 0;
      }

      transcriptionText.textContent = data.transcription.text || '(no speech detected)';
      transcriptionBox.classList.remove('hidden');

      sessionData.attempts++;
      sessionData.scores.push(score);
      sessionData.totalScore += score;
      sessionData.bestScore = Math.max(sessionData.bestScore, score);

      document.getElementById('streakCount').textContent = sessionData.streak;
      document.getElementById('avgScore').textContent = Math.round(sessionData.totalScore / sessionData.attempts);
      document.getElementById('totalAttempts').textContent = sessionData.attempts;
      document.getElementById('bestScore').textContent = `${sessionData.bestScore}%`;

      const wordAcc = Math.round(scores.word_accuracy);
      const charAcc = Math.round(scores.character_accuracy);
      const prosody = Math.round(scores.prosody);

      document.getElementById('wordAccuracyLabel').textContent = `${wordAcc}%`;
      document.getElementById('pronunciationLabel').textContent = `${charAcc}%`;
      document.getElementById('prosodyLabel').textContent = `${prosody}%`;

      document.getElementById('wordAccuracyBar').style.width = `${wordAcc}%`;
      document.getElementById('pronunciationBar').style.width = `${charAcc}%`;
      document.getElementById('prosodyBar').style.width = `${prosody}%`;

      scoreDisplay.classList.remove('hidden');
      actionButtons.classList.remove('hidden');
    }

    function resetUI() {
      scoreDisplay.classList.add('hidden');
      transcriptionBox.classList.add('hidden');
      actionButtons.classList.add('hidden');
      outputBox.textContent = "Tap mic to read the sentence aloud";
      outputBox.className = "text-center text-gray-600 mb-2 text-lg font-medium";
    }

    document.getElementById('tryAgainBtn').addEventListener('click', resetUI);
    document.getElementById('nextSentenceBtn').addEventListener('click', () => {
      currentSentenceIndex = (currentSentenceIndex + 1) % sentences.length;
      updateSentence();
      resetUI();
    });

    // Generate waveform bars
    const waveform = document.getElementById('waveform');
    for (let i = 0; i < 80; i++) {
      const bar = document.createElement('div');
      bar.className = 'wave-bar';
      bar.style.height = '20px';
      waveform.appendChild(bar);
    }
  </script>
</body>
</html>